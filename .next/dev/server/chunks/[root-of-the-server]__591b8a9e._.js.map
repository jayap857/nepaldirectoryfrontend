{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/acer/OneDrive/Desktop/nepaldirectoryfrontend/middleware.ts"],"sourcesContent":["import { NextResponse, NextRequest } from \"next/server\";\r\nimport { jwtVerify } from \"jose\";\r\n\r\nconst JWT_SECRET = new TextEncoder().encode(\r\n  process.env.JWT_SECRET || \"fallback-secret-change-in-prod\"\r\n);\r\nconst COOKIE_NAME = process.env.JWT_COOKIE_NAME || \"access_token\";\r\n\r\nconst protectedRoutes = [\r\n  \"/dashboard\",\r\n  \"/profile\",\r\n  \"/business/create\",\r\n  \"/my-reviews\",\r\n  \"/my-businesses\",\r\n];\r\nconst adminRoutes = [\"/admin\"];\r\nconst authRoutes = [\"/login\", \"/signup\"];\r\n\r\nasync function verifyToken(token: string) {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET, {\r\n      algorithms: [\"HS256\"],\r\n    });\r\n    return payload;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const { pathname, search } = request.nextUrl;\r\n  const token = request.cookies.get(COOKIE_NAME)?.value ?? null;\r\n\r\n  const isProtected = protectedRoutes.some((r) => pathname.startsWith(r));\r\n  const isAdmin = adminRoutes.some((r) => pathname.startsWith(r));\r\n  const isAuth = authRoutes.some((r) => pathname.startsWith(r));\r\n\r\n  const user = token ? await verifyToken(token) : null;\r\n\r\n  if (isAdmin) {\r\n    if (!user || !user.is_staff) {\r\n      const loginUrl = new URL(\"/login\", request.url);\r\n      loginUrl.searchParams.set(\"redirect\", pathname + search);\r\n      loginUrl.searchParams.set(\"message\", \"admin_required\");\r\n      return NextResponse.redirect(loginUrl);\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  if (isProtected && !user) {\r\n    const loginUrl = new URL(\"/login\", request.url);\r\n    loginUrl.searchParams.set(\"redirect\", pathname + search);\r\n    return NextResponse.redirect(loginUrl);\r\n  }\r\n\r\n  if (isAuth && user) {\r\n    const redirectTo = request.nextUrl.searchParams.get(\"redirect\") || \"/dashboard\";\r\n    return NextResponse.redirect(new URL(redirectTo, request.url));\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    \"/dashboard/:path*\",\r\n    \"/profile/:path*\",\r\n    \"/business/create/:path*\",\r\n    \"/my-reviews/:path*\",\r\n    \"/my-businesses/:path*\",\r\n    \"/admin/:path*\",\r\n    \"/login\",\r\n    \"/signup\",\r\n  ],\r\n  runtime: \"nodejs\", // ðŸ‘ˆ add this if youâ€™re using process.env\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CACzC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE5B,MAAM,cAAc,QAAQ,GAAG,CAAC,eAAe,IAAI;AAEnD,MAAM,kBAAkB;IACtB;IACA;IACA;IACA;IACA;CACD;AACD,MAAM,cAAc;IAAC;CAAS;AAC9B,MAAM,aAAa;IAAC;IAAU;CAAU;AAExC,eAAe,YAAY,KAAa;IACtC,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,oKAAS,EAAC,OAAO,YAAY;YACrD,YAAY;gBAAC;aAAQ;QACvB;QACA,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,QAAQ,OAAO;IAC5C,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,cAAc,SAAS;IAEzD,MAAM,cAAc,gBAAgB,IAAI,CAAC,CAAC,IAAM,SAAS,UAAU,CAAC;IACpE,MAAM,UAAU,YAAY,IAAI,CAAC,CAAC,IAAM,SAAS,UAAU,CAAC;IAC5D,MAAM,SAAS,WAAW,IAAI,CAAC,CAAC,IAAM,SAAS,UAAU,CAAC;IAE1D,MAAM,OAAO,QAAQ,MAAM,YAAY,SAAS;IAEhD,IAAI,SAAS;QACX,IAAI,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE;YAC3B,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;YAC9C,SAAS,YAAY,CAAC,GAAG,CAAC,YAAY,WAAW;YACjD,SAAS,YAAY,CAAC,GAAG,CAAC,WAAW;YACrC,OAAO,8IAAY,CAAC,QAAQ,CAAC;QAC/B;QACA,OAAO,8IAAY,CAAC,IAAI;IAC1B;IAEA,IAAI,eAAe,CAAC,MAAM;QACxB,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;QAC9C,SAAS,YAAY,CAAC,GAAG,CAAC,YAAY,WAAW;QACjD,OAAO,8IAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI,UAAU,MAAM;QAClB,MAAM,aAAa,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,eAAe;QACnE,OAAO,8IAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,YAAY,QAAQ,GAAG;IAC9D;IAEA,OAAO,8IAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,SAAS;AACX","debugId":null}}]
}